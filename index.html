<!DOCTYPE html>
<html>
<head>
  <!--Created by Greg Jopa - http://www.gregjopa.com/2010/12/html5-guitar-tab-player-with-firefox-audio-data-api/ -->
  <title>HTML5 Guitar Tab Player - By Greg Jopa</title>
  <script src="js/jquery-1.7.1.min.js"></script>
  <script src="js/raphael-min.js"></script>
  <script src="js/music.js"></script>
  <script src="js/audiolib.min.js"></script>
  <script src="js/drum-samples.js"></script>

  <!--vexflow.com guitar tab app-->
  <link href="tabdiv/tabdiv.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="tabdiv/vexflow.js"></script>
  <script src="tabdiv/vextabdiv.js"></script>

  <!-- custom js -->
  <script src="tabplayer.js"></script>

  <script>

    var tempo, showLoader, tabDiv, player;

    Vex.Flow.TabDiv.SEL = null; // vexflow - disable automatic initialization
  

    function play() {
      player.tempo = Number($('#txtTempo').val());
      player.play();

      var playDesc = "playing " + $("input[name='tab']:checked").val();
      $('#desc').empty().append(playDesc);
    }
  

    function stop() {
      player.stop();
      $('#desc').empty();
    }
 
   
    $(document).ready(function() {
      
      // click events
      $('#play').click(function() {
        play();
      });
    
      $('#stop').click(function() {
        stop();
      });
      
      $('input[name="tab"]').click(function() {
        loadXML(this.value);
      });

      $('#debug-grid').click(function() {
        if (player.debug) {
          player.debug = false;
          player.cursorCtx.clearRect(0, 0, player.cursorCanvas.width, player.cursorCanvas.height);
        }
        else {
          player.debug = true;
          player.drawDebugRectangles();
        }       
      });
      
    
      // load tab
      loadXML($("input[name='tab']:checked").val()); 
    });

  
    function loadXML(file) {
  
      showLoader = setTimeout("$('#loader').show()", 300);
      $('#tab').empty();
      $('#audio').empty();
    
      $.ajax({
      type: "GET",
      url: "musicxml/" + file,
      dataType: "xml",
        success: function(xml) { 
          
        var divisions, note, tab = "", noteType;
    
        $(xml).find('measure').each(function() {
          if(($(this).attr('number')-1)%4 == 0 || $(this).attr('number') == 1) {
            tab += "\n\ttabstave notation=true\n\tnotes";
          }
          else {
            tab += " |";
          }
      
          divisions = $(this).find('attributes').children('divisions').text();
      
          $(this).find("note").each(function() {
            // check for sharps               
            if($(this).find('pitch').children('alter').length == 0){
              note = $(this).find('pitch').children('step').text();
            }
            else{
              note = $(this).find('pitch').children('step').text() + "s";
            }

            switch ($(this).find('duration').text()/divisions) {
              case .125: noteType = '32'; break;
              case .25: noteType = '16'; break;
              case .5: noteType = '8'; break;
              case 1: noteType = 'q'; break;
              case 2: noteType = 'h'; break;
              case 4: noteType = 'w'; break;
              default: noteType = 'q';
            }

            tab += " :" + noteType + " " +
              $(this).find('notations').children('technical').children('fret').text() + "/" +
              $(this).find('notations').children('technical').children('string').text();
          });
        
        });
    

        $('#tab').append(tab);
    
        // vexflow - parse, create canvas, and redraw
        tabDiv = new Vex.Flow.TabDiv("#tab");
    
        tempo = Number($('#txtTempo').val());

        // initialize TabPlayer obj
        player = new TabPlayer(tabDiv, tempo);

        clearTimeout(showLoader);
        $('#loader').hide();
        }
      });  
    }

  </script>

</head>

<body>
  <div style="width:800px; margin:0px auto;">

    <h1>HTML5 Guitar Tab Player - Web Audio API</h1>
    <form name="tabform">
      <input type="radio" name="tab" value="Twinkle, Twinkle, Little Star.xml" checked /> 
        Twinkle, Twinkle, Little Star<br />
      <input type="radio" name="tab" value="12 Bar Blues (G).xml" /> 
        12 Bar Blues (key of G)<br />
      <input type="radio" name="tab" value="Minor Harmonic Scale (A).xml" /> 
        Minor Harmonic Scale (key of A)<br />
      <input type="radio" name="tab" value="Triad Exercise (C).xml" /> 
        Triad Exercise (key of C)<br />
      <input type="radio" name="tab" value="Blues Solo in E.xml" /> 
        Blues Solo in E<br />
    </form>
    <hr />
    <br />

    Tempo (bpm): <input type="text" id="txtTempo" value="120" />
    <button id="play">Play</button>
    <button id="stop">Stop</button>
    <button id="debug-grid">Toggle Debug Grid</button>
    <label id="desc" style="margin-left:40px;"></label>
  
    <div id="tab-wrapper" style="position: relative; text-align: center;">
      <img id="loader" src="tabdiv/loading.gif" alt="loading gif" />
      <div id="tab" class="vex-tabdiv" width=780 scale=1.0 editor="false"></div>
    </div>
  
  </div>
</body>
</html>